<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Monitoreo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="dashboard-container">
        <aside class="control-panel">
            <div class="logo"><h1>ARGOS</h1><span>MONITOR</span></div>
            <section class="controls-section">
                <h3>AÑADIR CÁMARA</h3>
                <form id="add-camera-form" class="control-group">
                    <label for="camera-name">Nombre Descriptivo</label>
                    <input type="text" id="camera-name" placeholder="Ej: Cámara Patio" required>
                    <label for="camera-url">URL de Cámara (RTSP)</label>
                    <input type="text" id="camera-url" placeholder="rtsp://..." required>
                    <button type="submit">Añadir Cámara</button>
                </form>
            </section>
            <section class="status-section">
                <h3>CÁMARAS CONFIGURADAS</h3>
                <ul id="camera-list" class="reference-list">
                    </ul>
            </section>
        </aside>

        <main class="video-section">
            <header>
                <h2>Video en Vivo</h2>
                <div class="live-indicator-container"><div class="live-indicator"></div><span>LIVE</span></div>
            </header>
            <div class="video-container">
                <img src="{{ url_for('video_feed') }}" alt="Esperando stream del agente local...">
            </div>
        </main>
    </div>

    <script>
        const API_URL = '/api/cameras';
        const cameraForm = document.getElementById('add-camera-form');
        const cameraList = document.getElementById('camera-list');

        // --- Carga las cámaras existentes al iniciar ---
        async function loadCameras() {
            const response = await fetch(API_URL);
            const cameras = await response.json();
            cameraList.innerHTML = '';
            for (const cam_id in cameras) {
                const camera = cameras[cam_id];
                const item = document.createElement('li');
                item.textContent = `${camera.name}: ${camera.url}`;
                cameraList.appendChild(item);
            }
        }

        // --- Envía el formulario para añadir una nueva cámara ---
        cameraForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const name = document.getElementById('camera-name').value;
            const url = document.getElementById('camera-url').value;

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, url })
            });
            const result = await response.json();

            if(result.success) {
                cameraForm.reset();
                loadCameras(); // Recargar la lista
            } else {
                alert('Error al añadir la cámara: ' + result.error);
            }
        });

        window.onload = loadCameras;
    </script>
</body>
</html>
